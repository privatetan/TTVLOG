# 事务

## 一、事务

### 1）事务

在事务中，数据库的一组操作要么全部成功，要么全部失败；

### 2）事务特性：ACID

- A：Atomicity，原子性，事务最小单元不可分割；
- C：Condidtency，一致性，数据库状态转换，没有破坏数据库完整性。
- I：Isolation，隔离性，各个事务相互隔离；
- D：Durability，持久性，事务提交，数据变化就是永久的。

### 3）事务分类

- ###### 扁平事务

  常用事务类型；

  扁平事务，所有操作都处于同一层次，由Begin开始，由Commit或Rollback结束；

  问题：回滚时，需要回滚整个事务。

- ###### 带有保存点的扁平事务

  带有保存点的扁平事务，除了支持扁平事务，允许在事务执行过程中回滚到同一事务较早的一个状态；

  **保存点**：

  - 事务中间状态，事务回滚时能回到该状态；
  - 使用save  transaction apoint_name;设置保存点。

  问题：当发生系统崩溃时，所有保存点将会消失，恢复时，事务需要重新从开始执行。

- ###### 链事务（可理解为：阶段性事务）

  可理解为**阶段性事务**，是带有保存点的扁平事务的改进版；

  链事务，在提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式地传给下一个要开始的事务；

  链事务中，提交事务和开始下一个事务操作将合并为一个原子操作，即下一个事务能看到上一个事务的结果；

  **带有保存点的扁平事务与链事务**

  同：

  - 两者都能回到某个状态；

  异：

  - 带有保存点的扁平事务能回滚到任意正确的保存点，链事务中的回滚仅限于当前事务，即只能恢复到最近一个的保存点。
  - 带有保存点的扁平事务不影响所持有的锁，链事务在Commit每阶段后即释放当前阶段事务持有的锁。

- ###### 嵌套事务

  层次结构框架：由一个顶层事务（top-level transaction）控制各个层次的事务（子事务，subtransaction）；

  嵌套事务定义

  1. 嵌套事务是由若干事务组成的一棵树，子树既可以是嵌套事务，也可以是扁平事务。
  2. 处在叶子节点的事务是扁平事务。
  3. 位于根节点的事务称为顶层事务，其他称为子事务。
  4. 子事务既可以提交也可以回滚，任何子事务都在顶层事务提交后才真正的提交。
  5. 树中的任意一个事务的回滚，会引起它的所有子事务一起回滚，故，子事务仅保留ACI特性，无D特性；

- ###### 分布式事务

  在分布式环境下运行的扁平事务；

  分布式事务，同样需要满足ACID特性；



## 二、事务的实现

Lock，锁，保证隔离性；

redo log：重做日志，保证原子性与持久性；

undo log：数据快照，保证一致性；

###### redo log 与 undo log

- redo log，重做日志，一种物理日志，用于恢复提交事务修改的页操作；
- undo log，数据快照，一种逻辑日志，用于回滚行记录到某个特定版本；

### 1）redo log：重做日志

###### redo log

重做日志，用来实现事务的持久性；

redo log由两部分组成：

1. 内存中的重做日志缓冲（redo log buffer），极易丢失；
2. 重做日志文件（redo log file），持久化到磁盘。

###### Force Log at Commit

InnoDB通过Force Log at Commit机制实现事务的持久性；

当事务提交时，必须先将该事务的所有日志写入到重做日志文件进行持久化，待事务的Commit操作才算完成。

###### InnoDB的重做日志文件：

InnoDB的重做日志文件由两部分组成：

1. redo log：用来保证事务持久性，顺序读写；
2. undo log：用来实现事务回滚及MVCC的功能，随机读写；

###### fsync：redo log写入磁盘操作；

重做日志都写入磁盘，每次将重做日志缓冲写入到重做日志文件后，InnoDB都需要调用一次fsync操作；

fsync的性能取决于磁盘性能，所以磁盘性能决定了事务的提交性能，也就决定数据库性能；

参数innodb_flush_log_at_trx_commit用来控制重做日志刷新到磁盘的策略：

- 1：默认值，表示事务提交时调用fsync操作；
- 0：表示事务提交时不调用fsync操作，而由master thread以每秒一次调用fsync操作；
- 2：表示事务提交时将仅将重做日志写入缓存，不进行fsync操作；

参数设置为0或2，控制写入磁盘操作，违背了事务的ACID特性；

###### binlog

binlog，是二进制文件，用来进行Point-in-Time（PIT）的恢复及主从复制（Replication）环境的建立；

###### redo log 与binlog

同：

- 都是数据库操作的日志；

异：

- 作用域：redo log产生与存储引擎层，仅针对与事务性存储引擎；binlog产生于MySQL服务层，针对于MySQL数据库的任何存储引擎对数据库的更改都会产生二进制日志；
- 记录内容：redo log是物理格式日志，用于记录每页的修改；binlog是逻辑日志，用于记录数据库操作对应的SQL语句；
- 刷盘时机：redo log在事务进行中不断写入；binlog只在事务提交后写入；

###### log block：日志块

在InnoDB中，重做日志缓存、重做日志文件都是以块（block）方式进行保存，称作重做日志块（redo log block），每块的大小为512字节。

三、事务的控制语句

四、隐式提交SQL语句

五、对于事务操作的统计

六、事务的隔离级别

七、分布式事务

八、错误的事务使用方式

九、长事务