# 索引与算法

## InnoDB索引

InnoDB支持的索引

- ###### B+树索引
  
  B+树索引是关系型数据库中最常用的索引类型；
  
  B+树索引的构造类似于二叉树，根据键值（key-vlaue）快速查找到数据。
  
  B+树中的B，代表平衡（Balance）而非二叉（Binary），B+树是从二叉树演化而来，但并非二叉树。
  
  B+树并不能找到一个给定值的具体行，B+索引查找的是数据行所在的页，数据库把页读到内存，然后在内存中进行查找数据。

- ###### 全文索引：
  
  MySQL5.6开始支持全文索引。
  
  使用全文索引前，搞清楚版本支持情况；
  
  全文索引比 like + % 快 N 倍，但是可能存在精度问题；
  
  如果需要全文索引的是大量数据，建议先添加数据，再创建索引；
  
  对于中文，可以使用 MySQL 5.7.6 之后的版本（引入ngram全文分析器），或者第三方插件。

- ###### 哈希索引
  
  InnoDB支持的哈希索引是自适应的：会根据表的使用情况自动为表生成哈希索引，不能人为干预。

## 数据结构与算法

### 二分查找法

二分查找法（binary search），又名折半查找法，用来查找一组有序元素数组的某一元素；

基本思想：将元素有序排列，按跳跃式查找，即，将有序数组的中间元素与目标元素进行对比，根据对比来缩小查找范围，每次比较，查找区间缩小一半。

## 二叉查找树和平衡二叉树

###### 二叉查找数

在二叉查找树中，左子树的键值总是小于根的键值，右子树的键值总是大于根的键值。

二叉树可以任意构造，但是链式二叉树（？暂译）性能是非常低的。

若想最大性能的构造棵二叉查找树，需要这棵树是平衡的即：平衡二叉树，又名AVL树。

###### 平衡二叉树

平衡二叉树，又AVL树，满足二叉查找树的定义，重要是必须满足任何节点的两个子树高度的高度差为1；

平和二叉树查询效率高，但是维护一棵平衡二叉树代价是非常大的：通常需要一次或者N次左旋和右旋来得到插入或更新后树的平衡。

## B+树

B+树，是由B树和索引顺序访问方法（ISAM）演化而来；

B+树，是为磁盘或其他存储辅助设备设计的一组平衡查找树，在B+树中，所有记录节点都是按键值的大小顺序存放在同一层的叶子节点上，由各叶子节点指针进行连接。

### B+树的插入操作

B+的插入必须保证插入后叶子节点的记录依然排序；

B+树插入的3种情况：

| Leaf Page满 | Index Page 满 | 操作                                                                                                                                                  |
|:----------:|:------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------- |
| No         | No           | 直接将记录插入到叶子节点                                                                                                                                        |
| Yes        | No           | 1.拆分Leaf Page<br/>2.将中间的节点放入到Index Page中；<br/>3.小于中间节点的记录放在左边；<br/>4.等于或大于中间节点的记录放右边。                                                               |
| Yes        | Yes          | 1.拆分Leaf Page<br/>2.小于中间节点的记录放在左边；<br/>3.等于或大于中间节点的记录放右边；<br/>4.拆分Index Page<br/>5.小于中间节点的记录放在左边；<br/>6.等于或大于中间节点的记录放右边；<br/>7.中间节点放入上一层Index Page。 |

为了保持平衡，对于新插入的键值，可能需要做大量的拆分页（split）操作；

因为B+树结构主要用于磁盘，页的拆分意味着磁盘的操作，所以应尽可能少的减少页的拆分操作；

B+提供了类似于平衡二叉树旋转（Rotation）功能，来减少页的拆分。

### B+树的删除操作

B+树使用填充因子（fill factor）来控制树的删除变化，50%是填充因子的最小值。

B+的删除也必须保证删除后叶子节点的记录依然排序；

B+树删除的3种情况：

| 叶子节点小于填充因子 | 中间节点小于填充因子 | 操作                                                                 |
|:----------:|:----------:| ------------------------------------------------------------------ |
| No         | No         | 直接将记录从叶子节点删除，<br/>如果该节点还是Index Page的节点，<br/>该节点的右节点代替。             |
| Yes        | No         | 合并叶子节点和它的兄弟节点，同时更新Index Page。                                      |
| Yes        | Yes        | 1. 合并叶子节点和它的兄弟节点；<br/>2. 更新Index Page；<br/>3. 合并Index Page和它的兄弟节点。 |



## B+树索引

B+树在数据库中有一个高扇出性，在数据库中，B+树的高度一般在2～4层；

B+树中索引可分为：**聚集索引**（Clustered index）和**辅助索引**（Secondary index）

不管是聚集还是辅助索引，内部都是B+树，叶子节点存放着所有的数据；

聚集和辅助不同的是，叶子节点存放的是否是一整行数据。



### 聚集索引

聚集索引，是根据表的主键构造的一棵B+树，叶子节点存放表的行记录数据，叶子节点称为数据页；

聚集索引中，索引组织表中数据也是索引的一部分；

数据页只能按照一棵B+树进行排序，所以每张表只能有一个聚集索引。

大多情况下，查询优化器倾向于采用聚集索引，因为聚集索引能够在B+树索引的叶子节点直接找到数据。由于定义了数据的逻辑顺序，聚集索引能够特别快的访问仅对范围值的查询。

聚集索引中：数据页存储的是完整的行记录，非数据页存储的是键值及指向数据页的偏移量。

聚集索引存储并不是物理上连续的，而是逻辑上连续的，原因有二：

1. 页是通过双向表链接，页按照主键的顺序排序；

2. 每个页中的记录也是通过双向链表维护，物理存储上可以不按照主键存储。

聚集索引的另一个好处是：对于主键的排序查找和范围查找速度非常快。

### 辅助索引

辅助索引：又非聚集索引，叶子节点并不包含行记录的全部数据。

叶子节点存放键值、可以找到行数据的书签（书签就是行数据的聚集索引键）；

每张表可以有多个辅助索引；

通过辅助索引查找数据时，InnoDB会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后通过主键索引来找到完整的行记录。

### B+树索引分裂

B+树索引页分裂并不总是从页的中间记录开始的，因为从中间开始会导致页空间的浪费。
