# InnoDB存储引擎

## InnoDB存储引擎

InnoDB是MySQL5.5默认的存储引擎；

InnoDB时第一个完整支持ACID事务的MySQL存储引擎；

InnoDB的特点是：行锁设计、支持MVCC、支持外键、提供一致性非锁定读，能有效的使用内存和CPU资源；

## InnoDB体系架构

InnoDB存储引擎有多个内存块，这些内存块组成了内存池，主要负责如下工作：

- 维护所有进程/线程需要访问的多个内部数据结构。
- 缓存磁盘上的数据，方便快速地读取，同时在对磁盘文件的数据修改之前在这里缓存。
- 重做日志（redo log）缓存。
- .....

### 后台线程

后台线程的主要作用是负责刷新内存池中的数据，保证缓冲池的内存缓存是最新数据，此外，将一修改的数据文件刷新到磁盘文件，同时保证在数据库发生异常时InnoDB能恢复到正常运行状态。

InnoDB存储引擎是多线程模型：后台会有多个不同的后台线程执行不同的任务；

- ###### Master Thread 

  核心的后台线程，主要负责将缓冲池中的数据异步刷新到磁盘，保证数据一致性，包括脏页的刷新、合并插入缓冲、Undo页的回收等。

- ###### IO Thread

  InnoDB中使用了大量的AIO来处理IO请求，极大的提高数据库的性能；

  IO Thread则负责AIO的IO请求的回调处理。

- ###### Purge Thread

  Purge Thread用来回收事务提交后，已经被使用的Undo页。

- ###### Page Cleaner Thread

  作用：将之前版本中脏页的刷新操作都放入到单独的线程来完成；

  目的：减轻原Master Thread的工作及对于用户查询线程的阻塞，进一步提高InnoDB的性能。

### 内存

1. #### 缓冲池

   缓冲池，一块内存区域，用于弥补磁盘I/O速度对数据库性能的影响，提高数据库整体性能。

   在数据库中，

   读取页时，先将从磁盘读到的页“fix”到缓冲池，再次读取时，先去缓冲池查找，找不到再去磁盘读取；

   操作页时，先操作缓冲池中的页，然后通过一定频率以Ckeckpoint机制刷回磁盘。

   通过参数：innodb_buffer_pool_size来设置缓冲池大小。

   缓冲池中的数据页类型：索引页、数据页、undo页、插入缓冲、自适应哈希索引、InnoDB存储的锁信息、数据字典信息等。

2. #### LRU List、Free List和Flush List

   缓冲池是通过LRU（最近最少使用）算法来进行管理的，即最频繁使用的页在LRU列表前端，最少使用的页在LRU列表尾端，缓冲池不能存放新的页时，会释放LRU列表尾端的页。

   在InnoDB中的LRU算法中，加入了innodb_old_blocks_pct参数（设置midpoint位置）和innodb_old_blocks_time参数（等待时间）来进一步管理LRU列表，保证热点数据的存活率。

3. #### 重做日志缓冲

   333

### Checkpoint技术



### Master Thread工作方式



### InnoDB关键特性

