# 并发标记

并发标记，主要是为转移过程提供信息。



## 并发标记

##### 简单标记

可从根节点（GcRoots）直接触达的所有对象都会被添加标记，带标记的是存活对象，不带标记的是死亡对象。

简单标记中，标记线程的执行会暂停mutator的运行（即：STW）。

##### 并发标记

并发标记中，标记线程和 mutator的运行几乎是并发进行的。

需要注意的是，并发标记其实并不是直接在对象上添加标记，而是在**标记位图**上添加标记。



## 标记位图

##### 标记位图

将用于标记的比特值等信息单独拿出来放到其他地方，用来匹配对应的对象。

每个区域（Region）带有两个标记位图

- next：本次标记的标记位图，保存本次标记的结果；
- prev：上次标记的标记位图，保存上次标记的结果。

标记位图中的每个比特（bit）都对应着关联区域内的对象的开头部分。



## 并发标记执行步骤

1. ##### 初始标记

   发生STW（暂停mutator的运行），标记可由根节点（GC Roots）直接引用的对象。

2. ##### 并发标记

   开启与mutator并发运行的线程，标记初始标记中标记的对象所引用的对象。

3. ##### 最终标记

   发生STW（暂停mutator的运行），标记”并发标记“中未被标记的对象。

4. ##### 存活对象计数

   开启与mutator并发运行的线程，统计每个区域（Region）中被标记的对象数量。

5. ##### 收尾工作

   发生STW（暂停mutator的运行），收尾工作，并未下次标记做准备。

### 初始标记

**发生STW（暂停mutator的运行），标记可由根节点（GC Roots）直接引用的对象。**



### 并发标记

**开启与mutator并发运行的线程，标记”初始标记“中标记的对象所引用的对象。**

### 最终标记

**发生STW（暂停mutator的运行），标记”并发标记“中未被标记的对象。**

**结束后，堆内所有存活对象都会被标记。**

### 存活对象计数

**开启与mutator并发运行的线程，统计每个区域（Region）中被标记的对象数量。**

### 收尾工作

**发生STW（暂停mutator的运行），收尾工作，并未下次标记做准备。**